<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title class="translate">marstek adapter settings</title>

  <link rel="stylesheet" type="text/css" href="../../css/adapter.css" />
  <link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

  <script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="../../socket.io/socket.io.js"></script>
  <script type="text/javascript" src="../../js/translate.js"></script>
  <script type="text/javascript" src="../../lib/js/materialize.js"></script>
  <script type="text/javascript" src="../../js/adapter-settings.js"></script>

  <style>
    /* Compact & robust layout (works in Admin4/5/6/7 incl. React wrapper) */
    .adapter-container { max-width: 980px; }
    .card { border-radius: 10px; }
    .card-content { padding: 18px 18px 6px 18px; }
    .hint { margin: 6px 0 0 0; color: rgba(0,0,0,.6); }

    /* IMPORTANT: In some Admin builds, Materialize hides selects globally.
       Force a normal HTML select to be visible and clickable. */
    select.browser-default {
      display: block !important;
      position: relative !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      height: 2.6rem !important;
      line-height: 2.6rem !important;
      width: 100% !important;
      border: 1px solid rgba(0,0,0,.2) !important;
      border-radius: 6px !important;
      background: #fff !important;
      padding-left: 8px !important;
    }
    /* Keep label spacing nice */
    .select-label { display: block; margin-bottom: 6px; color: rgba(0,0,0,.65); font-size: .9rem; }
  </style>
</head>

<body>
  <div class="m adapter-container">
    <div class="row">
      <div class="col s12">
        <h5 class="translate">Marstek Venus settings</h5>
        <p class="hint translate">Enter device connection settings and polling parameters.</p>
      </div>
    </div>

    <div class="row">
      <div class="col s12">
        <div class="card z-depth-1">
          <div class="card-content">
            <div class="row">
              <div class="input-field col s12 m7">
                <input class="value" id="ip" type="text" />
                <label for="ip" class="translate active">Device IP</label>
              </div>

              <div class="input-field col s12 m5">
                <input class="value" id="port" type="number" min="1" max="65535" />
                <label for="port" class="translate active">UDP Port</label>
              </div>
            </div>

            <div class="row">
              <div class="col s12 m4">
                <label for="modelGroup" class="translate select-label">Model group</label>
                <select class="value browser-default" id="modelGroup">
                  <option value="auto" selected>Auto</option>
                  <option value="ce">Venus C / E</option>
                  <option value="d">Venus D</option>
                </select>
              </div>

              <div class="input-field col s12 m4">
                <input class="value" id="pollIntervalSec" type="number" min="5" max="3600" />
                <label for="pollIntervalSec" class="translate active">Poll interval (sec)</label>
              </div>

              <div class="input-field col s12 m4">
                <input class="value" id="timeoutMs" type="number" min="1000" max="30000" />
                <label for="timeoutMs" class="translate active">UDP timeout (ms)</label>
              </div>
            </div>

            <div class="row">
              <div class="input-field col s12 m4">
                <input class="value" id="interCallDelayMs" type="number" min="0" max="1000" />
                <label for="interCallDelayMs" class="translate active">Inter-call delay (ms)</label>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript">
  function applyDefaults(settings) {
    if (settings.ip === undefined) settings.ip = '';
    if (settings.port === undefined) settings.port = 30000;
    if (settings.modelGroup === undefined) settings.modelGroup = 'auto';
    if (settings.pollIntervalSec === undefined) settings.pollIntervalSec = 15;
    if (settings.timeoutMs === undefined) settings.timeoutMs = 8000;
    if (settings.interCallDelayMs === undefined) settings.interCallDelayMs = 150;
    return settings;
  }

  function load(settings, onChange) {
    if (!settings) return;
    settings = applyDefaults(settings);

    $('#ip').val(settings.ip);
    $('#port').val(settings.port);
    $('#modelGroup').val(settings.modelGroup || 'auto');
    $('#pollIntervalSec').val(settings.pollIntervalSec);
    $('#timeoutMs').val(settings.timeoutMs);
    $('#interCallDelayMs').val(settings.interCallDelayMs);

    if (M && M.updateTextFields) M.updateTextFields();

    // Do NOT call $('select').formSelect(); because Admin builds may hide native selects.
    // We intentionally use a plain HTML select (browser-default).

    $('.value').on('change keyup', function () { onChange(); });
    onChange(false);
  }

  function save(callback) {
    var obj = {};
    obj.ip = $('#ip').val();
    obj.port = Number($('#port').val());
    obj.modelGroup = $('#modelGroup').val() || 'auto';
    obj.pollIntervalSec = Number($('#pollIntervalSec').val());
    obj.timeoutMs = Number($('#timeoutMs').val());
    obj.interCallDelayMs = Number($('#interCallDelayMs').val());
    callback(obj);
  }
</script>

</body>
</html>
